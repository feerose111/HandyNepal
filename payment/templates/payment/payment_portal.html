{% extends "base.html" %}
{% load static %}

{% block title %}HandyNepal - Payment Portal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/payment.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="payment-card">
                    <h2 class="text-center mb-4">Complete Your Order</h2>
                    
                    <!-- Order Summary -->
                    <div class="order-summary mb-4">
                        <h4>Order Summary</h4>
                        <div id="order-items">
                            <!-- Order items will be loaded dynamically -->
                        </div>
                        <div class="order-total mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between">
                                <span class="font-weight-bold">Total Amount:</span>
                                <span class="font-weight-bold" id="order-total">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <form id="payment-form" method="POST" action="{% url 'payment:process_payment' %}">
                        {% csrf_token %}
                        
                        <!-- Personal Information -->
                        <div class="form-section mb-4">
                            <h4>Personal Information</h4>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" required>
                            </div>
                        </div>

                        <!-- Delivery Address -->
                        <div class="form-section mb-4">
                            <h4>Delivery Address</h4>
                            <div class="mb-3">
                                <label for="address" class="form-label">Full Address</label>
                                <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section mb-4">
                            <h4>Payment Method</h4>
                            <div class="mb-3">
                                <label for="paymentType" class="form-label">Select Payment Type</label>
                                <select class="form-select" id="paymentType" name="paymentType" required>
                                    <option value="" selected disabled>Choose payment method</option>
                                    <option value="cash">Cash on Delivery</option>
                                    <option value="esewa">eSewa</option>
                                </select>
                            </div>
                            
                            <!-- eSewa details (shown only when eSewa is selected) -->
                            <div id="esewaDetails" style="display: none;">
                                <div class="alert alert-info">
                                    <p>You will be redirected to eSewa payment gateway after submitting this form.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="termsCheck" required>
                            <label class="form-check-label" for="termsCheck">
                                I agree to the <a href="{% url 'terms_and_conditions' %}" target="_blank">Terms and Conditions</a>
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">Complete Order</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load cart items from localStorage
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const orderItems = document.getElementById('order-items');
    const orderTotal = document.getElementById('order-total');
    
    // Display order items
    if (cart.length > 0) {
        let total = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            
            const itemHtml = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h6 class="mb-0">${item.name}</h6>
                        <small class="text-muted">$${item.price.toFixed(2)} x ${item.quantity}</small>
                    </div>
                    <span>$${itemTotal.toFixed(2)}</span>
                </div>
            `;
            
            orderItems.insertAdjacentHTML('beforeend', itemHtml);
        });
        
        orderTotal.textContent = `$${total.toFixed(2)}`;
    } else {
        orderItems.innerHTML = '<p class="text-center">No items in cart</p>';
        orderTotal.textContent = '$0.00';
    }
    
    // Show/hide eSewa details based on payment type selection
    const paymentType = document.getElementById('paymentType');
    const esewaDetails = document.getElementById('esewaDetails');
    
    if (paymentType && esewaDetails) {
        paymentType.addEventListener('change', function() {
            if (this.value === 'esewa') {
                esewaDetails.style.display = 'block';
            } else {
                esewaDetails.style.display = 'none';
            }
        });
    }
    
    // Handle form submission
    const paymentForm = document.getElementById('payment-form');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedPaymentType = paymentType.value;
            
            if (selectedPaymentType === 'cash') {
                // Process cash on delivery
                alert('Your order has been placed successfully! You will pay on delivery.');
                
                // Clear the cart
                localStorage.removeItem('cart');
                
                // Redirect to home page
                window.location.href = '/';
            } else if (selectedPaymentType === 'esewa') {
                // Redirect to eSewa payment (this would be replaced with actual eSewa integration)
                alert('You will be redirected to eSewa payment gateway.');
                
                // In a real implementation, you would:
                // 1. Create an order in your database
                // 2. Generate the eSewa payment parameters
                // 3. Redirect to eSewa or submit a form to eSewa
                
                // For now, just simulate success
                localStorage.removeItem('cart');
                window.location.href = '/';
            }
        });
    }
});
</script>
{% endblock %} 